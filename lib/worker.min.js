(function(){function e(e){return e&&typeof e.then=="function"}function t(e){this.succeedCBs=[],this.failCBs=[],this.__hasValue=!1,this.__hasFailed=!1,this.value=void 0,e&&this.fulfill(e)}function r(t,r,o){if(null===o)t.isRejected()?r.reject(t.value):r.fulfill(t.value);else{var n;try{n=o(t.value)}catch(i){console.error?console.error("Promise exception thrown",i,'("'+i.toString()+'")'):console.log("Promise exception thrown",i,'("'+i.toString()+'")'),r.reject(i)}e(n)?s(n).chain(r):r.fulfill(n)}}function o(e,t){Array.isArray(e)||(e=[e]);var r=s(),o=e.length,n=0;if(0===o)return r.fulfill([]),r;var i=[];i.length=o;for(var a=[],l=function(e,s,l){i[s]=e,l&&a.push(s),++n==o&&(t?t(i,a)?r.fulfill(i):r.reject(i):r.fulfill(i))},u=0;o>u;u++)s(e[u]).succeed(l,u,!1).fail(l,u,!0);return r}function n(e){return o(e,function(e,t){return t.length===0})}function i(e){return o(e,function(e,t){return t.length<e.length})}function s(r){if(arguments.length>1)return o(Array.prototype.slice.call(arguments));if(r instanceof t)return r;if(e(r)){var n=s();return r.then(function(e){n.fulfill(e)},function(e){n.reject(e)}),n}return new t(r)}var a=this;"undefined"!=typeof window?(typeof window.local=="undefined"&&(window.local={}),a=window.local):"undefined"!=typeof self?(typeof self.local=="undefined"&&(self.local={}),a=self.local):"undefined"!=typeof module&&(a=module.exports),t.prototype.isUnfulfilled=function(){return!this.__hasValue},t.prototype.isRejected=function(){return this.__hasFailed},t.prototype.isFulfilled=function(){return this.__hasValue&&!this.__hasFailed},t.prototype.then=function(e,t){e=e&&"function"==typeof e?e:null,t=t&&"function"==typeof t?t:null;var o=s();if(this.isUnfulfilled())this.succeedCBs.push({p:o,fn:e}),this.failCBs.push({p:o,fn:t});else{var n=this;setTimeout(function(){n.isFulfilled()?r(n,o,e):r(n,o,t)},0)}return o},t.prototype.succeed=function(e){if(this.isRejected())return this;var t=Array.prototype.slice.call(arguments,1);return this.then(function(r){return e.apply(null,[r].concat(t))})},t.prototype.fail=function(e){if(this.isFulfilled())return this;var t=Array.prototype.slice.call(arguments,1);return this.then(null,function(r){return e.apply(null,[r].concat(t))})},t.prototype.fulfill=function(e){if(this.isUnfulfilled()){this.value=e,this.__hasValue=!0;for(var t=0;t<this.succeedCBs.length;t++){var o=this.succeedCBs[t];r(this,o.p,o.fn)}this.succeedCBs.length=0,this.failCBs.length=0}return this},t.prototype.reject=function(e){if(this.isUnfulfilled()){this.value=e,this.__hasValue=!0,this.__hasFailed=!0;for(var t=0;t<this.failCBs.length;t++){var o=this.failCBs[t];r(this,o.p,o.fn)}this.succeedCBs.length=0,this.failCBs.length=0}return this},t.prototype.cancel=function(){var e;for(e=0;e<this.succeedCBs.length;e++)this.succeedCBs[e].p.cancel();for(e=0;e<this.failCBs.length;e++)this.failCBs[e].p.cancel();return this.succeedCBs.length=0,this.failCBs.length=0,this},t.prototype.chain=function(e){return this.then(function(t){return s(e).fulfill(t),t},function(t){return s(e).reject(t),t}),e},t.prototype.cb=function(e,t){e?this.reject(e):this.fulfill("undefined"==typeof t?null:t)},a.Promise=t,a.promise=s,a.promise.bundle=o,a.promise.all=n,a.promise.any=i})(),"undefined"!=typeof define&&define([],function(){return Promise}),typeof this.local=="undefined"&&(this.local={}),typeof this.local.util=="undefined"&&(this.local.util={}),function(){function e(){this._events={}}e.prototype.emit=function(e){var t=this._events[e];if(!t)return!1;for(var r=Array.prototype.slice.call(arguments,1),o=0,n=t.length;n>o;o++)t[o].apply(this,r);return!0},e.prototype.addListener=function(e,t){if(Array.isArray(e))return e.forEach(function(e){this.addListener(e,t)},this),void 0;if("function"!=typeof t)throw new Error("addListener only takes instances of Function");return this.emit("newListener",e,t),this._events[e]?this._events[e].push(t):this._events[e]=[t],this},e.prototype.on=e.prototype.addListener,e.prototype.once=function(e,t){var r=this;r.on(e,function o(){r.removeListener(e,o),t.apply(this,arguments)})},e.prototype.removeListener=function(e,t){if("function"!=typeof t)throw new Error("removeListener only takes instances of Function");if(!this._events[e])return this;var r=this._events[e],o=r.indexOf(t);return 0>o?this:(r.splice(o,1),r.length===0&&delete this._events[e],this)},e.prototype.removeAllListeners=function(e){return e&&this._events[e]&&(this._events[e]=null),this},e.prototype.listeners=function(e){return this._events[e]},local.util.EventEmitter=e}(),typeof this.local=="undefined"&&(this.local={}),typeof this.local.http=="undefined"&&(this.local.http={}),typeof this.local.http.ext=="undefined"&&(this.local.http.ext={}),function(){function e(){}function t(e,t){if(!e||"object"!=typeof e||!t)return e;var r=i(t,"serializer");return r?r(e):e}function r(e,t){if(!e||"string"!=typeof e||!t)return e;var r=i(t,"deserializer");return r?r(e):e}function o(e,t,r){U[e]={serializer:t,deserializer:r}}function n(e){var t=e.split(";"),r=t[0];if(t=r.split("/"),t[1]){var o=t[1].split("+");return o[1]?[r,t[0]+"/"+o[1],t[0]]:[r,t[0]]}return[r]}function i(e,t){for(var r=n(e),o=0;o<r.length;o++)if(r[o]in U)return U[r[o]][t];return null}function s(e,t){t.status>=200&&t.status<400?e.fulfill(t):t.status>=400&&t.status<600||t.status===0?e.reject(t):e.fulfill(t)}function a(e,t){var r=M[e.urld.host];if(!r){var o=new p(404,"server not found");return t.reject(o),o.end(),void 0}var n={path:e.urld.path,method:e.method,query:e.query||{},headers:e.headers||{},body:e.body,stream:e.stream};if(e.urld.query){var i=local.http.contentTypes.deserialize(e.urld.query,"application/x-www-form-urlencoded");for(var s in i)n.query[s]=i[s]}r.fn.call(r.context,n,new h(t,e.stream))}function l(e,t){if(e.query){var r=local.http.contentTypes.serialize(e.query,"application/x-www-form-urlencoded");r&&(e.urld.query?(e.urld.query+="&"+r,e.urld.relative+="&"+r):(e.urld.query=r,e.urld.relative+="?"+r))}"undefined"!=typeof window?u(e,t):c(e,t)}function u(e,t){var r=(e.urld.protocol?e.urld.protocol+"://":"")+e.urld.authority+e.urld.relative;e.headers=local.http.ext.headerer(e.headers).serialize(),e.body!==null&&typeof e.body!="undefined"&&(e.headers["content-type"]=e.headers["content-type"]||"application/json",typeof e.body!="string"&&(e.body=local.http.contentTypes.serialize(e.body,e.headers["content-type"])));var o=new XMLHttpRequest;o.open(e.method,r,!0);for(var n in e.headers)e.headers[n]!==null&&e.headers.hasOwnProperty(n)&&o.setRequestHeader(n,e.headers[n]);var i,a=0,l=0;o.onreadystatechange=function(){o.readyState>=XMLHttpRequest.HEADERS_RECEIVED&&!i&&(i=new p(o.status,o.statusText),o.getAllResponseHeaders().split("\n").forEach(function(e){if(e){var t=e.toLowerCase().replace("\r","").split(": ");i.headers[t[0]]=t[1]}}),i.headers.link&&(i.headers.link=local.http.parseLinkHeader(i.headers.link)),e.stream&&(s(t,i),a=setInterval(function(){var e=o.responseText.length;e>l&&(l=e,i.write(o.responseText,!0))},e.streamPoll||500))),o.readyState===XMLHttpRequest.DONE&&(i=i||new p(o.status,o.statusText),a&&clearInterval(a),i.write(o.responseText,!0),i.end(),e.stream||s(t,i))},o.send(e.body)}function c(e,t){var r=new p(0,"dispatch() has not yet been implemented for nodejs");t.reject(r),r.end()}function p(e,t){local.util.EventEmitter.call(this),this.status=e,this.reason=t,this.headers={},this.body=null,this.isConnOpen=!0}function h(e,t){local.util.EventEmitter.call(this),this.resPromise=e,this.isStreaming=t,this.clientResponse=new p}function f(e){var t=new g(local.http.dispatch({method:"get",url:"httpl://"+e.urld.authority+e.urld.relative,headers:{accept:"text/event-stream"},stream:!0}));return t}function d(e){return"undefined"!=typeof window?v(e):y(e)}function v(e){var t=(e.urld.protocol||"http")+"://"+e.urld.authority+e.urld.relative;return new w(t)}function y(){throw"subscribe() has not yet been implemented for nodejs"}function m(){local.util.EventEmitter.call(this),this.isConnOpen=!0}function g(e){m.call(this);var t=this;e.then(function(e){e.on("data",function(e){t.__emitEvent(e)}),e.on("end",function(){t.close()})},function(e){t.__emitError({event:"error",data:e}),t.close()})}function w(e){m.call(this),this.eventSource=new EventSource(e);var t=this;this.eventSource.onerror=function(e){e.target.readyState==EventSource.CLOSED&&t.close()}}function b(){return"undefined"!=typeof window?window.location.host:app?app.config.environmentHost:""}function x(e,t,r){this.rel=e,this.relparams=t,this.url=r,this.resolveState=x.UNRESOLVED,this.error=null}function E(e,t){if(this.context=e||null,this.parentNavigator=t||null,this.links=null,typeof this.context=="string")this.context=new x(null,null,e);else if(!t)throw"parentNavigator is required for navigators with relative contexts"}function k(){this.streams=[]}function L(e){if(e&&"object"==typeof e)for(var t in e)e.hasOwnProperty(t)&&(this[t]=e[t])}function R(e){this.response=e}function A(e){return J.indexOf(e)===-1}function q(e,t){return A(t)?e.headers?e.headers[t]:null:e[t]}function S(e,t){return e.indexOf(t)!==-1}function _(e){return e instanceof RegExp?e:Array.isArray(e)?new RegExp("^"+e.join("|")+"$","gi"):new RegExp("^"+e+"$","gi")}function C(e){this.request=e,this.isRouted=!1,this.bestMatch=[]}local.http.parseLinkHeader=function(e){return"string"!=typeof e?e:e.replace(/,[\s]*</g,"|||<").split("|||").map(function(e){var t={};return e.trim().split(";").forEach(function(e){if(e=e.trim())if(e.charAt(0)==="<")t.href=e.trim().slice(1,-1);else{var r=e.split("="),o=r[0].trim(),n=r[1].trim().slice(1,-1);t[o]=n}}),t})},local.http.lookupLink=function(e,t,r){var o=e?e.length:0;if(!o)return null;r=r.toLowerCase();for(var n=null,i=0;o>i;i++){var s=e[i];if(s&&s.rel&&s.rel.indexOf(t)!==-1)if(s.title){if(s.title.toLowerCase()===r){n=s;break}}else n=s}return n?n.href:null},local.http.joinUrl=function(){var e=Array.prototype.map.call(arguments,function(e){var t=0,r=e.length;return e.charAt(0)==="/"&&(t+=1),e.charAt(r-1)==="/"&&(r-=1),e.substring(t,r)});return e.join("/")},local.http.parseUri=function(e){"object"==typeof e&&(e.url?e=e.url:(e.host||e.path)&&(e=local.http.joinUrl(req.host,req.path)));for(var t=local.http.parseUri.options,r=t.parser[t.strictMode?"strict":"loose"].exec(e),o={},n=14;n--;)o[t.key[n]]=r[n]||"";return o[t.q.name]={},o[t.key[12]].replace(t.q.parser,function(e,r,n){r&&(o[t.q.name][r]=n)}),o},local.http.parseUri.options={strictMode:!1,key:["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"],q:{name:"queryKey",parser:/(?:^|&)([^&=]*)=?([^&]*)/g},parser:{strict:/^(?:([^:\/?#]+):)?(?:\/\/((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?))?((((?:[^?#\/]*\/)*)([^?#]*))(?:\?([^#]*))?(?:#(.*))?)/,loose:/^(?:(?![^:@]+:[^:@\/]*@)([^:\/?#.]+):)?(?:\/\/)?((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/}};var j={serialize:t,deserialize:r,register:o},U={};local.http.contentTypes=j,local.http.contentTypes.register("application/json",function(e){try{return JSON.stringify(e)}catch(t){return t.message}},function(e){try{return JSON.parse(e)}catch(t){return t.message}}),local.http.contentTypes.register("application/x-www-form-urlencoded",function(e){var t=encodeURIComponent,r=[];for(var o in e)if(e[o]===null)r.push(o+"=");else if(Array.isArray(e[o]))for(var n=0;n<e[o].length;n++)r.push(o+"[]="+t(e[o][n]));else if(typeof e[o]=="object")for(var i in e[o])r.push(o+"["+i+"]="+t(e[o][i]));else r.push(o+"="+t(e[o]));return r.join("&")},function(e){for(var t=e.split("&"),r={},o=0;o<t.length;o++){var n=t[o].split("="),i=decodeURIComponent(n[0]),s=decodeURIComponent(n[1]),a=/\[\]$/.test(i),l=i.match(/^(.+)\[([^\]]+)\]$/);if(l){i=l[1];var u=l[2];r[i]=r[i]||{},r[i][u]=s}else a?(i=i.substring(0,i.length-2),r[i]=r[i]||[],r[i].push(s)):r[i]=s}return r});var M={},O=null,T="undefined"!=typeof window?window.location.pathname.split("/"):[""];T[T.length-1]="",T=T.join("/"),local.http.dispatch=function(e){if(!e)throw"no req param provided to request";if(e.headers=e.headers||{},e.query=e.query||{},O)return O(e);if(e.url||(e.url=local.http.joinUrl(e.host,e.path)),e.urld=local.http.parseUri(e.url),!e.urld)throw"no URL or host/path provided in request";e.urld.protocol||(e.url=e.url.length>0&&e.url.charAt(0)!="/"?window.location.protocol+"//"+window.location.host+T+e.url:window.location.protocol+"//"+window.location.host+e.url,e.urld=local.http.parseUri(e.url));var t=local.promise();if(e.urld.protocol=="httpl")setTimeout(function(){a(e,t)},0);else if(e.urld.protocol=="http"||e.urld.protocol=="https")setTimeout(function(){l(e,t)},0);else{var r=new p(0,'unsupported protocol "'+e.urld.protocol+'"');t.reject(r),r.end()}return t},local.http.setRequestDispatcher=function(e){O=e},local.http.ClientResponse=p,p.prototype=Object.create(local.util.EventEmitter.prototype),p.prototype.write=function(e,t){if(t||"string"!=typeof e||typeof this.body!="string"){var r=this.body&&typeof this.body=="string"?this.body.length:0;this.body=e,e="string"==typeof e?e.slice(r):e}else this.body+=e;this.emit("data",e)},p.prototype.end=function(){this.__deserialize(),this.isConnOpen=!1,this.emit("end")},p.prototype.__deserialize=function(){typeof this.body=="string"&&(this.body=local.http.contentTypes.deserialize(this.body,this.headers["content-type"]))},local.http.ServerResponse=h,h.prototype=Object.create(local.util.EventEmitter.prototype),h.prototype.writeHead=function(e,t,r){this.clientResponse.status=e,this.clientResponse.reason=t;for(var o in r)r.hasOwnProperty(o)&&this.setHeader(o,r[o]);this.isStreaming&&s(this.resPromise,this.clientResponse)},h.prototype.setHeader=function(e,t){this.clientResponse.headers[e]=t},h.prototype.getHeader=function(e){return this.clientResponse.headers[e]},h.prototype.removeHeader=function(e){delete this.clientResponse.headers[e]},h.prototype.write=function(e){this.clientResponse.write(e,!1)},h.prototype.end=function(e){e&&this.write(e),this.clientResponse.end(),this.emit("close"),this.isStreaming||s(this.resPromise,this.clientResponse),this.removeAllListeners("close"),this.clientResponse.removeAllListeners("data"),this.clientResponse.removeAllListeners("end")},h.prototype.writeContinue=e,h.prototype.addTrailers=e,h.prototype.sendDate=e,local.http.registerLocal=function(e,t,r){var o=local.http.parseUri(e);if(o.protocol&&o.protocol!=="httpl")throw"registerLocal can only add servers to the httpl protocol";if(!o.host)throw"invalid domain provided to registerLocal";if(M[o.host])throw"server already registered at domain given to registerLocal";M[o.host]={fn:t,context:r}},local.http.unregisterLocal=function(e){var t=local.http.parseUri(e);if(!t.host)throw"invalid domain provided toun registerLocal";M[t.host]&&delete M[t.host]},local.http.getLocal=function(e){var t=local.http.parseUri(e);if(!t.host)throw"invalid domain provided toun registerLocal";return M[t.host]},local.http.getLocalRegistry=function(){return M};var T="undefined"!=typeof window?window.location.pathname.split("/"):[""];T[T.length-1]="",T=T.join("/");var N=null;local.http.subscribe=function(e){if(!e)throw"no options provided to subscribe";if("string"==typeof e&&(e={url:e}),N)return N(e);if(e.url||(e.url=local.http.joinUrl(e.host,e.path)),e.urld=local.http.parseUri(e.url),!e.urld)throw"no URL or host/path provided in request";return e.urld.protocol||(e.url=e.url.length>0&&e.url.charAt(0)!="/"?window.location.protocol+"//"+window.location.host+T+e.url:window.location.protocol+"//"+window.location.host+e.url,e.urld=local.http.parseUri(e.url)),e.urld.protocol=="httpl"?f(e):d(e)},local.http.setEventSubscriber=function(e){N=e},local.http.EventStream=m,m.prototype=Object.create(local.util.EventEmitter.prototype),m.prototype.close=function(){this.isConnOpen=!1,this.removeAllListeners()},m.prototype.__emitError=function(e){this.emit("message",e),this.emit("error",e)},m.prototype.__emitEvent=function(e){this.emit("message",e),this.emit(e.event,e)},local.http.LocalEventStream=g,g.prototype=Object.create(m.prototype),g.prototype.close=function(){this.__emitError({event:"error",data:void 0}),m.prototype.close.call(this)},local.http.BrowserRemoteEventStream=w,w.prototype=Object.create(m.prototype),w.prototype.addListener=function(e,t){if(Array.isArray(e))return e.forEach(function(e){this.addListener(e,t)},this),void 0;if(!this._events[e]){var r=this;this.eventSource.addEventListener(e,function(e){var t=e.data;try{t=JSON.parse(t)}catch(o){}r.__emitEvent({event:e.type,data:t})})}local.util.EventEmitter.prototype.addListener.call(this,e,t)},w.prototype.on=w.prototype.addListener,w.prototype.close=function(){this.eventSource.close(),this.eventSource.onerror=null,this.eventSource=null,m.prototype.close.call(this)},function(){"use strict";function e(e){return Object.prototype.toString.apply(e)==="[object Array]"}function t(e,t,r){var o,n=r;for(o in e)e.hasOwnProperty(o)&&(n=t(n,e[o],o,e));return n}function r(e,t,r){var o,n=r;for(o=0;o<e.length;o+=1)n=t(n,e[o],o,e);return n}function o(o,n,i){return e(o)?r(o,n,i):t(o,n,i)}function n(t){var r,o;if(null===t||void 0===t)return!1;if(e(t)){for(r=0;r<t.length;r+=1)if(n(t[r]))return!0;return!1}if("string"==typeof t||"number"==typeof t||"boolean"==typeof t)return!0;for(o in t)if(t.hasOwnProperty(o)&&n(t[o]))return!0;return!1}function i(e){return e>="a"&&"z">=e||e>="A"&&"Z">=e}function s(e){return e>="0"&&"9">=e}function a(e){return s(e)||e>="a"&&"f">=e||e>="A"&&"F">=e}function l(e){return i(e)||s(e)||"_"===e||g.isPctEncoded(e)}function u(e){return i(e)||s(e)||"-"===e||"."===e||"_"===e||"~"===e}function c(e){return":"===e||"/"===e||"?"===e||"#"===e||"["===e||"]"===e||"@"===e||"!"===e||"$"===e||"&"===e||"("===e||")"===e||"*"===e||"+"===e||","===e||";"===e||"="===e||"'"===e}function p(e,t){var r,o="",n="";for(("number"==typeof e||"boolean"==typeof e)&&(e=e.toString()),r=0;r<e.length;r+=n.length)n=g.pctCharAt(e,r),o+=n.length>1?n:u(n)||t&&c(n)?n:g.encodeCharacter(n);return o}function h(e){return p(e,!0)}function f(e,t){this.templateText=e,this.expressions=t}function d(e){var t,r="",o="";for(t=0;t<e.length;t+=o.length)o=g.pctCharAt(e,t),r+=o.length>0?o:c(o)||u(o)?o:g.encodeCharacter(o);return r}function v(e){this.literal=d(e)}function y(e,t,r){this.templateText=e,this.operator=t,this.varspecs=r}function m(e){function t(){c={varname:o.substring(p,i),exploded:!1,maxLength:null},p=null}function r(){if(h===i)throw new Error("after a ':' you have to specify the length. position = "+i);c.maxLength=parseInt(o.substring(h,i),10),h=null}var o,n,i,a,u=[],c=null,p=null,h=null;for(o=e.substr(1,e.length-2),i=0;i<o.length;i+=a.length){if(a=g.pctCharAt(o,i),0===i){if(n=w.valueOf(a),n.symbol!==""){p=1;continue}p=0}if(null!==p){if("."===a){if(p===i)throw new Error("a varname MUST NOT start with a dot -- see position "+i);continue}if(l(a))continue;t()}if(null!==h){if(s(a))continue;r()}if(":"!==a)if("*"!==a){if(","!==a)throw new Error("illegal character '"+a+"' at position "+i);u.push(c),c=null,p=i+1}else{if(null===c)throw new Error("explode exploded at position "+i);if(c.exploded)throw new Error("explode exploded twice at position "+i);if(c.maxLength)throw new Error("an explode (*) MUST NOT follow to a prefix, see position "+i);c.exploded=!0}else{if(c.maxLength!==null)throw new Error("only one :maxLength is allowed per varspec at position "+i);h=i+1}}return null!==p&&t(),null!==h&&r(),u.push(c),new y(e,n,u)}var g=function(){function e(e){return unescape(encodeURIComponent(e))}function t(t){var r,o,n="",i=e(t);for(o=0;o<i.length;o+=1)r=i.charCodeAt(o),n+="%"+r.toString(16).toUpperCase();return n}function r(e){if(e.length<3)return!1;for(var t=0;t<e.length;t+=3)if(e.charAt(t)!=="%"||!a(e.charAt(t+1)||!a(e.charAt(t+2))))return!1;return!0}function o(e,t){var o=e.charAt(t);return"%"!==o?o:(o=e.substr(t,3),r(o)?o:"%")}return{encodeCharacter:t,decodeCharacter:decodeURIComponent,isPctEncoded:r,pctCharAt:o}}(),w=function(){function e(e){t[e]={symbol:e,separator:"?"===e?"&":""===e||"+"===e||"#"===e?",":e,named:";"===e||"&"===e||"?"===e,ifEmpty:"&"===e||"?"===e?"=":"",first:"+"===e?"":e,encode:"+"===e||"#"===e?h:p,toString:function(){return this.symbol}}}var t={};return e(""),e("+"),e("#"),e("."),e("/"),e(";"),e("?"),e("&"),{valueOf:function(e){if(t[e])return t[e];if("=,!@|".indexOf(e)>=0)throw new Error('Illegal use of reserved operator "'+e+'"');return t[""]}}}();f.prototype.toString=function(){return this.templateText},f.prototype.expand=function(e){var t,r="";for(t=0;t<this.expressions.length;t+=1)r+=this.expressions[t].expand(e);return r},v.prototype.expand=function(){return this.literal},v.prototype.toString=v.prototype.expand,y.prototype.toString=function(){return this.templateText},y.prototype.expand=function(t){function r(e,t,r){return n(t)&&(e.length>0&&(e+=","),c||(e+=f.encode(r)+","),e+=f.encode(t)),e}function i(e,t,r){return n(t)&&(e.length>0&&(e+=f.separator),e+=c?d(l.varname):f.encode(r),e+="="+f.encode(t)),e}function s(e,t,r){return n(t)&&(e.length>0&&(e+=f.separator),c||(e+=f.encode(r)+"="),e+=f.encode(t)),e}var a,l,u,c,p="",h=!0,f=this.operator;for(a=0;a<this.varspecs.length;a+=1)if(l=this.varspecs[a],u=t[l.varname],n(u))if(h?(p+=this.operator.first,h=!1):p+=this.operator.separator,c=e(u),"string"==typeof u||"number"==typeof u||"boolean"==typeof u){if(u=u.toString(),this.operator.named){if(p+=d(l.varname),""===u){p+=this.operator.ifEmpty;continue}p+="="}l.maxLength&&u.length>l.maxLength&&(u=u.substr(0,l.maxLength)),p+=this.operator.encode(u)}else{if(l.maxLength)throw new Error("Prefix modifiers are not applicable to variables that have composite values. You tried to expand "+this+" with "+JSON.stringify(u));if(l.exploded)p+=o(u,f.named?i:s,"");else{if(f.named){if(p+=d(l.varname),!n(u)){p+=this.operator.ifEmpty;continue}p+="="}p+=o(u,r,"")}}return p},f.parse=function(e){var t,r,o=[],n=null,i=0;for(t=0;t<e.length;t+=1)if(r=e.charAt(t),null===i){if(null===n)throw new Error("reached unreachable code");if("{"===r)throw new Error("brace was opened in position "+n+" and cannot be reopened in position "+t);if("}"===r){if(n+1===t)throw new Error("empty braces on position "+n);o.push(m(e.substring(n,t+1))),n=null,i=t+1}}else{if("}"===r)throw new Error("brace was closed in position "+t+" but never opened");"{"===r&&(t>i&&o.push(new v(e.substring(i,t))),i=null,n=t)}if(null!==n)throw new Error("brace was opened on position "+n+", but never closed");return i<e.length&&o.push(new v(e.substr(i))),new f(e,o)},local.http.UriTemplate=f}();var z=["head","post","put","patch","delete"],B={Json:"application/json",Html:"text/html",Xml:"text/xml",Events:"text/event-stream",Eventstream:"text/event-stream",Plain:"text/plain",Text:"text/plain"},H=["alternate","author","collection","current","describedby","first","index","item","last","latest-version","monitor","monitor-group","next","next-archive","payment","predecessor-version","prev","prev-archive","related","replies","search","self","service","successor-version","up","version-history","via","working-copy","working-copy-of"];x.UNRESOLVED=0,x.RESOLVED=1,x.FAILED=2,x.prototype.isResolved=function(){return this.resolveState===x.RESOLVED},x.prototype.isBad=function(){return this.resolveState>1},x.prototype.isRelative=function(){return!this.url&&!!this.rel},x.prototype.isAbsolute=function(){return!!this.url},x.prototype.getUrl=function(){return this.url},x.prototype.getError=function(){return this.error},x.prototype.getHost=function(){if(!this.host){if(!this.url)return null;var e=local.http.parseUri(this.url);this.host=(e.protocol||"http")+"://"+(e.authority||b())}return this.host},x.prototype.resetResolvedState=function(){this.resolveState=x.UNRESOLVED,this.error=null},x.prototype.resolve=function(e){this.error=null,this.resolveState=x.RESOLVED,this.url=e;var t=local.http.parseUri(this.url);this.host=(t.protocol||"http")+"://"+t.authority},local.http.ext.Navigator=E,E.prototype.dispatch=function(e){if(!e||!e.method)throw"request options not provided";var t=this,r=local.promise();return(e.noresolve?local.promise(this.context.getUrl()):this.resolve({retry:e.retry})).succeed(function(t){return e.url=t,local.http.dispatch(e)}).succeed(function(e){return t.context.error=null,t.context.resolveState=x.RESOLVED,t.links=e.headers.link?e.headers.link:t.links||[],e}).fail(function(e){throw e.status===404&&(t.context.error=e,t.context.resolveState=x.FAILED),e}).chain(r),r},E.prototype.subscribe=function(){return this.resolve().succeed(function(e){return local.http.subscribe(e)})},E.prototype.relation=function(e,t,r){var o=r||{};return o.title=(t||"").toLowerCase(),new E(new x(e,o),this)},E.prototype.resolve=function(e){var t=this,r=local.promise();return this.links!==null&&(this.context.isResolved()||this.context.isAbsolute()&&this.context.isBad()===!1)?r.fulfill(this.context.getUrl()):this.context.isBad()===!1||this.context.isBad()&&e.retry?(this.context.resetResolvedState(),this.parentNavigator?this.parentNavigator.__resolveChild(this,e).succeed(function(){return t.head(null,null,null,{noresolve:!0})}).succeed(function(){return t.context.getUrl()}).chain(r):this.head(null,null,null,{noresolve:!0}).succeed(function(){return t.context.getUrl()}).chain(r)):r.reject(this.context.getError()),r},E.prototype.__resolveChild=function(e,t){var r=this,o=local.promise();return this.resolve(t).then(function(){var t=r.__lookupLink(e.context);if(t)e.context.resolve(t),o.fulfill(t);else{var n=new local.http.ClientResponse(404,"link relation not found");o.reject(n),n.end()}},function(t){return e.context.error=t,e.context.resolveState=x.FAILED,o.reject(t),t}),o},E.prototype.__lookupLink=function(e){var t=local.http.lookupLink(this.links,e.rel,e.relparams.title);if(t){var r=local.http.UriTemplate.parse(t).expand(e.relparams),o=local.http.parseUri(r);return o.host||(r=this.context.getHost()+o.relative),r}return console.log("Failed to find a link to resolve context. Target link:",e.rel,e.relparams,"Navigator:",this),null},z.forEach(function(e){E.prototype[e]=function(t,r,o,n){var i=n||{};return i.headers=o||{},i.method=e,null!==t&&"null"!=typeof t&&/head/i.test(e)===!1&&(i.headers["content-type"]=r||("object"==typeof t?"application/json":"text/plain")),i.body=t,this.dispatch(i)}}),E.prototype.get=function(e,t,r){var o=r||{};return o.headers=t||{},o.method="get",o.headers.accept=e,this.dispatch(o)};for(var I in B)(function(e,t){E.prototype["get"+e]=function(e,r){return this.get(t,e,r)}})(I,B[I]);H.forEach(function(e){var t=e.replace(/-/g,"_");E.prototype[t]=function(t,r){return this.relation(e,t,r)}}),local.http.ext.navigator=function(e){return e instanceof E?e:new E(e)},local.http.ext.Broadcaster=k,k.prototype.addStream=function(e){this.streams.push(e)},k.prototype.endStream=function(e){this.streams=this.streams.filter(function(t){return t!=e}),e.end()},k.prototype.endAllStreams=function(){this.streams.forEach(function(e){e.end()}),this.streams.length=0},k.prototype.emit=function(e,t){this.streams.forEach(function(r){this.emitTo(r,e,t)},this)},k.prototype.emitTo=function(e,t,r){e.write({event:t,data:r})},local.http.ext.broadcaster=function(){return new k},local.http.ext.Headerer=L,L.prototype.addLink=function(e,t,r){var o=r||{};return o.href=e,o.rel=t,this.link||(this.link=[]),this.link.push(o),this},L.prototype.setAuth=function(e){return this.authorization=e,this},L.prototype.serialize=function(){if(this.link&&Array.isArray(this.link))throw"Link header serialization is not yet implemented";if(this.authorization&&typeof this.authorization=="object"){if(!this.authorization.scheme)throw"`scheme` required for auth headers";var e;switch(this.authorization.scheme.toLowerCase()){case"basic":e="Basic "+btoa(this.authorization.name+":"+this.authorization.password);break;case"persona":e="Persona name="+this.authorization.name+" assertion="+this.authorization.assertion;break;default:throw"unknown auth sceme: "+this.authorization.scheme}this.authorization=e}return this},local.http.ext.headerer=function(e){return e instanceof L?e:new L(e)};var P={processing:[102,"server has received and is processing the request"],ok:[200,"ok"],created:[201,"request has been fulfilled; new resource created"],accepted:[202,"request accepted, processing pending"],shouldBeOk:[203,"request processed, information may be from another source"],nonauthInfo:[203,"request processed, information may be from another source"],noContent:[204,"request processed, no content returned"],resetContent:[205,"request processed, no content returned, reset document view"],partialContent:[206,"partial resource return due to request header"],multipleChoices:[300,"multiple options for the resource delivered"],movedPermanently:[301,"this and all future requests directed to the given URI"],found:[302,"response to request found via alternative URI"],seeOther:[303,"response to request found via alternative URI"],notModified:[304,"resource has not been modified since last requested"],useProxy:[305,"content located elsewhere, retrieve from there"],switchProxy:[306,"subsequent requests should use the specified proxy"],temporaryRedirect:[307,"connect again to different uri as provided"],badRequest:[400,"request cannot be fulfilled due to bad syntax"],unauthorized:[401,"authentication is possible but has failed"],forbidden:[403,"server refuses to respond to request"],notFound:[404,"requested resource could not be found"],methodNotAllowed:[405,"request method not supported by that resource"],notAcceptable:[406,"content not acceptable according to the Accept headers"],conflict:[409,"request could not be processed because of conflict"],gone:[410,"resource is no longer available and will not be available again"],preconditionFailed:[412,"server does not meet request preconditions"],unsupportedMediaType:[415,"server does not support media type"],teapot:[418,"I'm a teapot"],enhanceYourCalm:[420,"rate limit exceeded"],unprocessableEntity:[422,"request unable to be followed due to semantic errors"],locked:[423,"resource that is being accessed is locked"],failedDependency:[424,"request failed due to failure of a previous request"],internalServerError:[500,"internal server error"],serverError:[500,"internal server error"],notImplemented:[501,"server does not recognise method or lacks ability to fulfill"],badGateway:[502,"server received an invalid response from upstream server"],serviceUnavailable:[503,"server is currently unavailable"],unavailable:[503,"server is currently unavailable"],gatewayTimeout:[504,"gateway did not receive response from upstream server"],insufficientStorage:[507,"server is unable to store the representation"],notExtended:[510,"further extensions to the request are required"]},D={text:"text/plain",plain:"text/plain",json:"application/json",html:"text/html",xml:"text/xml","events-stream":"text/event-stream"};local.http.ext.Responder=R,R.prototype.respond=function(e,t,r){var o;return Array.isArray(e)&&(o=e[1],e=e[0]),r=r||{},t&&(r["content-type"]=D[t]||t),this.response.writeHead(e,o,r),this.response};for(var F in P)(function(e){R.prototype[F]=function(t,r){return this.respond(e,t,r)}})(P[F]);R.prototype.pipe=function(e,t,r){t=t||function(e){return e},r=r||function(e){return e};var o=this,n=local.promise(e);return n.succeed(function(e){return o.response.status||o.response.writeHead(e.status,e.reason,t(e.headers)),e.body!==null&&typeof e.body!="undefined"&&o.response.write(r(e.body)),e.on&&e.isConnOpen?(e.on("data",function(e){o.response.write(r(e))}),e.on("end",function(){o.response.end()})):o.response.end(),e}).fail(function(e){console.log("response piping error from upstream:",e);var t=e.response.headers["content-type"]||"text/plain",r=t&&e.response.body?e.response.body:"";throw o.badGateway(t).end(r),e}),n},R.prototype.cb=function(e,t,r,o){var n=this[e],i=this;return function(e){return n.call(i,t,r).end(o),e}},R.setTypeAlias=function(e,t){D[e]=t},local.http.ext.responder=function(e){return e instanceof R?e:new R(e)};var V=["p","pm","pma","pmat","pmta","pmt","pa","pt","m","ma","mat","mta","mt","mp","mpa","mpt","mpat","mpta","a","at","t"],$={p:"path",m:"method",a:"accept",t:"content-type"},J=["path","method","query","body","stream"];
local.http.ext.Router=C,C.prototype.route=function(e,t){if("function"!=typeof t)throw"a handler callback must be given to the route";if(this.isRouted)return this;var r,o,n,i={},s=[],a=!0;for(var l in e)n=e[l],o=q(this.request,l),"path"==l&&o.charAt(0)!="/"&&(o="/"+o),r=n.exec(o),null!==r&&r!==!1?(i[l]=r,s.push(l)):(a=!1,(S(s,"path")||S(s,"method"))&&s.length>this.bestMatch.length&&(this.bestMatch=s));return a&&(t.call(this,i),this.isRouted=!0),this},C.prototype.error=function(e,t){if(this.isRouted)return this;var r=local.http.ext.responder(e),o=this.bestMatch.concat(t);S(o,"path")?S(o,"method")?!S(o,"content-type")&&this.request.body?r.unsupportedMediaType().end():!S(o,"accept")&&this.request.headers.accept?r.notAcceptable().end():r.badRequest().end():r.methodNotAllowed().end():r.notFound().end()},V.forEach(function(e){var t=e.split("").map(function(e){return $[e]});C.prototype[e]=function(){var e={},r=0;for(r;r<t.length;r++){var o=t[r];e[o]=_(arguments[r])}var n=arguments[r];return this.route(e,n)}}),C.setTypeAlias=function(e,t){D[e]=t},local.http.ext.router=function(e){return e instanceof C?e:new C(e)}}(),typeof this.local=="undefined"&&(this.local={}),typeof this.local.worker=="undefined"&&(this.local.worker={}),function(){function e(e,t){var r=e.charCodeAt(t)&255;return r}function t(e,t){return t="(function(){ var module = { exports:{} }; "+t+'; self.modules["'+e+'"] = module.exports; })();',"data:text/javascript;base64,"+btoa(t)}(function(){function e(){return o++}function t(t,r,o){var n={id:e(),reply_to:o,name:t,data:r};return n}function r(e,t,r){t&&"function"==typeof t&&(n[e.id]={func:t,context:r}),self.postMessage(e)}var o=1,n={},i={};self.addEventListener("message",function(e){var t=e.data;if(t.name==="reply"){var r=n[t.reply_to];if(r)return r.func.call(r.context,t),delete n[t.reply_to],void 0}var o=i[t.name];if(t.name==="endMessage"){var s=t.data;o=i[s],local.worker.removeAllNamedMessageListeners(s)}o&&o.forEach(function(e){e.func.call(e.context,t)})}),local.worker.postNamedMessage=function(e,o,n,i){var s=t(e,o);return r(s,n,i),s.id},local.worker.postReply=function(e,o,n,i){var s="object"==typeof e?e.id:e,a=t("reply",o,s);return r(a,n,i),a.id},local.worker.endMessage=function(e){return local.worker.postNamedMessage("endMessage",e)},local.worker.addNamedMessageListener=function(e,t,r){e in i||(i[e]=[]),i[e].push({func:t,context:r})},local.worker.onNamedMessage=local.worker.addNamedMessageListener,local.worker.removeNamedMessageListener=function(e,t){if(e in i){var r=function(e){return e.func!=t};i[e]=i[e].filter(r),i[e].length===0&&delete i[e]}},local.worker.removeAllNamedMessageListeners=function(e){e in i&&delete i[e]}})(),local.http.setRequestDispatcher(function(e){if("function"==typeof e)return local.worker.logStack();var t=local.promise();return local.worker.postNamedMessage("httpRequest",e,function(r){if(!r.data)throw"Invalid httpRequest reply to worker from document";var o=new local.http.ClientResponse(r.data.status,r.data.reason);o.headers=r.data.headers,!e.stream&&r.data.body&&o.write(r.data.body),o.status>=200&&o.status<300?t.fulfill(o):o.status>=400||!o.status?t.reject(o):t.fulfill(o),e.stream&&r.data.body&&o.write(r.data.body),local.worker.onNamedMessage(r.id,function(e){e.name==="endMessage"?o.end():o.write(e.data)})}),t}),local.http.setEventSubscriber(function(e){var t=new local.http.EventStream,r=local.worker.postNamedMessage("httpSubscribe",e);return t.addListener=t.on=function(e,t){local.worker.postNamedMessage(r,e,function(e){local.worker.onNamedMessage(e.id,function(e){t(e.data)})})},t}),local.worker.onNamedMessage("httpRequest",function(e){var t=e.data;if(main){var r=function(t){var r=local.worker.postReply(e,t);t.isConnOpen?(t.on("data",function(e){local.worker.postNamedMessage(r,e)}),t.on("end",function(){local.worker.endMessage(r)})):local.worker.endMessage(r)},o=local.promise();o.then(r,r);var n=new local.http.ServerResponse(o,t.stream);main(t,n)}else{var i=local.worker.postReply(e,{status:404,reason:"server not loaded"});local.worker.endMessage(i)}});var r=importScripts,o=XMLHttpRequest;if(local.worker.log=function(){var e=Array.prototype.slice.call(arguments);e.length>1?local.worker.postNamedMessage("log",e):local.worker.postNamedMessage("log",e[0])},self.console={},self.console.log=local.worker.log,local.worker.logStack=function(){try{stack_trace._fake+=0}catch(e){console.log(e.stack)}},!self.btoa){var n="=",i="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";self.btoa=function(t){var r,o,s=n,a=i,l=[];t=""+t;var u=t.length-t.length%3;if(t.length===0)return t;for(r=0;u>r;r+=3)o=e(t,r)<<16|e(t,r+1)<<8|e(t,r+2),l.push(a.charAt(o>>18)),l.push(a.charAt(63&o>>12)),l.push(a.charAt(63&o>>6)),l.push(a.charAt(63&o));switch(t.length-u){case 1:o=e(t,r)<<16,l.push(a.charAt(o>>18)+a.charAt(63&o>>12)+s+s);break;case 2:o=e(t,r)<<16|e(t,r+1)<<8,l.push(a.charAt(o>>18)+a.charAt(63&o>>12)+a.charAt(63&o>>6)+s)}return l.join("")}}self.require=function(e){if(e in self.modules)return self.modules[e];local.worker.config&&e.indexOf("://")===-1&&e.charAt(0)!="/"&&(e=local.worker.config.scriptBaseUrl+e);var n=new o;return n.open("GET",e,!1),n.send(null),n.status>=200&&n.status<300?/\.js$/.test(e)?(r(t(e,n.responseText)),self.modules[e]):(self.modules[e]=n.responseText,n.responseText):(console.log("Failed to require("+e+") - "+n.status),null)},self.modules={},local.worker.onNamedMessage("nullify",function(e){if(console.log("nullifying: "+e.data),!e||typeof e.data!="string")throw"'nullify' message must include a valid string";self[e.data]=null}),local.worker.onNamedMessage("importScripts",function(e){if(console.log("importingScripts: "+e.data),!e||!e.data)throw"'importScripts' message must include a valid array/string";try{r(e.data)}catch(t){throw local.worker.postReply(e,{error:!0,reason:t.toString()}),t}local.worker.postReply(e,{error:!1})}),local.worker.postNamedMessage("ready",null,function(e){local.worker.config=e.data})}();